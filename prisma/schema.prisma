generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CEO
  PM
  CTO
  SENIOR_DEVELOPER
  DEVELOPER
}

enum TaskStatus {
  BACKLOG
  READY
  IN_PROGRESS
  DEV_TEST
  TESTING
  DONE
  REJECTED
}

enum TaskType {
  UI
  AUTH
  API
  REFACTOR
  CHART
}

enum ActivityLogType {
  MANUAL
  WFH
}

enum ManualLogCategory {
  LEARNING
  RESEARCH
  OTHER
}

enum NotificationType {
  TASK_MOVEMENT
  CREATION_ASSIGNMENT
  TASK_ASSIGNED
  USER_LOG_COMMENT
  TIME_REQUEST
}

enum CommentEntityType {
  TASK
  MANUAL_LOG
}

enum TaskTimeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TaskBreakReason {
  NAMAZ
  LUNCH
  DINNER
  REFRESHMENT
  OTHER
}

enum TaskWorkSessionSource {
  AUTO
  WFH
}

enum AttendanceBreakType {
  LUNCH
  DINNER
  NAMAZ
  REFRESHMENT
  OTHER
}

model User {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  name             String
  email            String        @unique
  password         String
  role             UserRole
  isActive         Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  createdProjects  Project[]     @relation("ProjectCreator")
  memberProjects   ProjectMember[]
  ownedTasks       Task[]        @relation("TaskOwner")
  activityLogs     ActivityLog[]
  statusChanges    TaskStatusHistory[] @relation("TaskStatusHistoryChangedBy")
  commentsWritten  Comment[]     @relation("CommentCreator")
  commentReadStates CommentReadState[]
  taskTimeRequests TaskTimeRequest[] @relation("TaskTimeRequestCreator")
  taskTimeReviews  TaskTimeRequest[] @relation("TaskTimeRequestReviewer")
  taskBreaks       TaskBreak[]
  taskWorkSessions TaskWorkSession[]
  notificationsAuthored Notification[] @relation("NotificationActor")
  notificationRecipients NotificationRecipient[]
  attendances      Attendance[]
  attendanceBreaks AttendanceBreak[]
}

model Project {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  createdById String      @db.ObjectId
  createdBy   User        @relation("ProjectCreator", fields: [createdById], references: [id])
  members     ProjectMember[]
  milestones  Milestone[]
  notifications Notification[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model ProjectMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId String   @db.ObjectId
  project   Project  @relation(fields: [projectId], references: [id])
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([projectId, userId])
}

model Milestone {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  startDate DateTime
  endDate   DateTime
  projectId String   @db.ObjectId
  project   Project  @relation(fields: [projectId], references: [id])
  tasks     Task[]
  notifications Notification[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  title          String
  description    String
  status         TaskStatus
  type           TaskType
  ownerId        String         @db.ObjectId
  owner          User           @relation("TaskOwner", fields: [ownerId], references: [id])
  milestoneId    String         @db.ObjectId
  milestone      Milestone      @relation(fields: [milestoneId], references: [id])
  estimatedHours Float
  reworkCount    Int            @default(0)
  totalTimeSpent Int            @default(0)
  lastStartedAt  DateTime?
  checklistItems ChecklistItem[]
  statusHistory  TaskStatusHistory[]
  timeLogs       TaskTimeLog[]
  timeRequests   TaskTimeRequest[]
  breaks         TaskBreak[]
  workSessions   TaskWorkSession[]
  activityLogs   ActivityLog[]
  notifications  Notification[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime?      @updatedAt
}

model TaskTimeLog {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String     @db.ObjectId
  task      Task       @relation(fields: [taskId], references: [id])
  status    TaskStatus
  startedAt DateTime
  endedAt   DateTime?
  createdAt DateTime   @default(now())
}

model TaskTimeRequest {
  id               String                @id @default(auto()) @map("_id") @db.ObjectId
  taskId           String                @db.ObjectId
  task             Task                  @relation(fields: [taskId], references: [id])
  requestedById    String                @db.ObjectId
  requestedBy      User                  @relation("TaskTimeRequestCreator", fields: [requestedById], references: [id])
  requestedSeconds Int
  reason           String
  status           TaskTimeRequestStatus @default(PENDING)
  reviewedById     String?               @db.ObjectId
  reviewedBy       User?                 @relation("TaskTimeRequestReviewer", fields: [reviewedById], references: [id])
  reviewedAt       DateTime?
  createdAt        DateTime              @default(now())
}

model TaskBreak {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  taskId          String          @db.ObjectId
  task            Task            @relation(fields: [taskId], references: [id])
  userId          String          @db.ObjectId
  user            User            @relation(fields: [userId], references: [id])
  reason          TaskBreakReason?
  reasons         TaskBreakReason[]   @default([])
  note            String?
  startedAt       DateTime
  endedAt         DateTime?
  durationSeconds Int             @default(0)
  endedBy         String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model TaskStatusHistory {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  taskId      String     @db.ObjectId
  task        Task       @relation(fields: [taskId], references: [id])
  fromStatus  TaskStatus?
  toStatus    TaskStatus
  changedById String     @db.ObjectId
  changedBy   User       @relation("TaskStatusHistoryChangedBy", fields: [changedById], references: [id])
  changedAt   DateTime   @default(now())
}

model ChecklistItem {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  taskId      String  @db.ObjectId
  task        Task    @relation(fields: [taskId], references: [id])
  label       String
  isCompleted Boolean @default(false)
}

model ActivityLog {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  userId      String           @db.ObjectId
  user        User             @relation(fields: [userId], references: [id])
  taskId      String?          @db.ObjectId
  task        Task?            @relation(fields: [taskId], references: [id])
  date        DateTime         @default(now())
  description String
  categories  ManualLogCategory[] @default([])
  type        ActivityLogType  @default(MANUAL)
  startAt     DateTime?
  endAt       DateTime?
  durationSeconds Int          @default(0)
  workSession TaskWorkSession?
}

model Attendance {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  date      DateTime
  inTime    DateTime?
  outTime   DateTime?
  note      String?
  autoOff   Boolean   @default(false)
  autoOffReason String?
  wfhIntervals AttendanceWFHInterval[]
  breaks    AttendanceBreak[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model AttendanceBreak {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  attendanceId    String              @db.ObjectId
  attendance      Attendance          @relation(fields: [attendanceId], references: [id])
  type            AttendanceBreakType?
  types           AttendanceBreakType[] @default([])
  startAt         DateTime
  endAt           DateTime?
  durationMinutes Int
  notes           String?
  endedBy         String?
  createdByUserId String              @db.ObjectId
  createdByUser   User                @relation(fields: [createdByUserId], references: [id])
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([attendanceId])
  @@index([createdByUserId])
}

model AttendanceWFHInterval {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  attendanceId String     @db.ObjectId
  attendance   Attendance @relation(fields: [attendanceId], references: [id])
  startAt      DateTime
  endAt        DateTime
  createdAt    DateTime   @default(now())

  @@index([attendanceId])
}

model TaskWorkSession {
  id          String                @id @default(auto()) @map("_id") @db.ObjectId
  taskId      String                @db.ObjectId
  task        Task                  @relation(fields: [taskId], references: [id])
  userId      String                @db.ObjectId
  user        User                  @relation(fields: [userId], references: [id])
  activityLogId String?             @db.ObjectId
  activityLog ActivityLog?          @relation(fields: [activityLogId], references: [id])
  startedAt   DateTime
  endedAt     DateTime?
  durationSeconds Int               @default(0)
  endedBy     String?
  source      TaskWorkSessionSource @default(AUTO)
  createdAt   DateTime              @default(now())

  @@unique([activityLogId])
  @@index([taskId])
  @@index([userId])
  @@index([userId, endedAt])
}

model Comment {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  message      String
  createdById  String   @db.ObjectId
  createdBy    User     @relation("CommentCreator", fields: [createdById], references: [id])
  entityType   CommentEntityType
  entityId     String   @db.ObjectId
  mentions     String[]
  createdAt    DateTime @default(now())
}

model CommentReadState {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])
  entityType CommentEntityType
  entityId   String   @db.ObjectId
  lastReadAt DateTime @default(now())

  @@unique([userId, entityType, entityId])
}

model Notification {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  type        NotificationType
  actorId     String            @db.ObjectId
  actor       User              @relation("NotificationActor", fields: [actorId], references: [id])
  message     String
  taskId      String?           @db.ObjectId
  task        Task?             @relation(fields: [taskId], references: [id])
  projectId   String?           @db.ObjectId
  project     Project?          @relation(fields: [projectId], references: [id])
  milestoneId String?           @db.ObjectId
  milestone   Milestone?        @relation(fields: [milestoneId], references: [id])
  createdAt   DateTime          @default(now())
  recipients  NotificationRecipient[]
}

model NotificationRecipient {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  notificationId String        @db.ObjectId
  notification   Notification  @relation(fields: [notificationId], references: [id])
  userId         String        @db.ObjectId
  user           User          @relation(fields: [userId], references: [id])
  readAt         DateTime?
  createdAt      DateTime      @default(now())

  @@unique([notificationId, userId])
}
